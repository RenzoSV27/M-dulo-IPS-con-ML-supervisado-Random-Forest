<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPS - Tr√°fico de Red</title>
  <link rel="stylesheet" href="IPS.css">
</head>
<body>
  <div class="app-ips">
    <header class="cabecera-ips">
      <div class="marca-cabecera">
        <div class="logo-ips">
          <img src="../upnLogo.png" alt="Logo Universidad Privada del Norte">
        </div>
        <div>
          <p class="supertexto-cabecera">Sistemas Inteligentes y Aprendizaje Autom√°tico</p>
          <h1>Tr√°fico de Red - IPS</h1>
        </div>
      </div>
      <nav class="navegacion-ips">
        <a href="../panelAdmin.html">Inicio</a>
        <a class="active" href="#">Tr√°fico de Red</a>
        <a href="alertas.html">Alertas</a>
      </nav>
      <div class="meta-cabecera">
        <span>Monitoreo permanente</span>
        <span>Modelos entrenados</span>
      </div>
    </header>

    <main class="principal-ips">
      <section class="destacado-ips">
        <div class="texto-destacado">
          <h2>Visi√≥n central de la red institucional</h2>
          <p>Alertas y m√©tricas en tiempo real para la Universidad Privada del Norte.</p>
        </div>
        <div class="contadores-destacados">
          <div class="contador-destacado">
            <span class="etiqueta-contador">Paquetes capturados</span>
            <strong id="contador-paquetes">0 paquetes</strong>
          </div>
          <div class="contador-destacado">
            <span class="etiqueta-contador">Alertas cr√≠ticas</span>
            <strong id="contador-alertas">0 alertas</strong>
          </div>
          <div class="contador-destacado">
            <span class="etiqueta-contador">√öltima actualizaci√≥n</span>
            <strong id="ultima-actualizacion">Actualizando...</strong>
          </div>
        </div>
      </section>

      <section id="seccion-alertas" class="alertas-ips">
        <div class="tarjeta-alertas">
          <div class="encabezado-alertas">
            <p>üö® Alertas de Seguridad</p>
          </div>
          <div id="lista-alertas" class="lista-alertas">
            <!-- Las alertas se cargar√°n aqu√≠ -->
          </div>
        </div>
      </section>

      <section class="seccion-tabla">
        <div class="encabezado-tabla">
          <h2>Tr√°fico de Red</h2>
          <p>√öltimos 20 paquetes registrados por el IPS.</p>
        </div>
        <div class="contenedor-tabla">
          <table class="tabla-ips">
            <thead>
              <tr>
                <th>Hora</th>
                <th>IP Origen</th>
                <th>Puerto Origen</th>
                <th>IP Destino</th>
                <th>Puerto Destino</th>
                <th>Protocolo</th>
                <th>Etiqueta</th>
              </tr>
            </thead>
            <tbody id="tabla-trafico">
              <tr><td colspan="7">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="pie-ips">
      <p>2025 Sistema IPS ¬∑ Sistemas Inteligentes y Aprendizaje Autom√°tico ¬∑ Universidad Privada del Norte</p>
    </footer>
  </div>

  <script>
    async function cargarDatos() {
      try {
        const respuesta = await fetch('CapturaTrafico/trafico.json');
        if (!respuesta.ok) throw new Error("No se pudo cargar el archivo JSON");
        
        const datos = await respuesta.json();
        const tabla = document.getElementById('tabla-trafico');
        tabla.innerHTML = "";

        // Actualizar contador y hora
        const contador = document.getElementById('contador-paquetes');
        const ultimaAct = document.getElementById('ultima-actualizacion');
        const ahora = new Date();
        const hora = ahora.toLocaleTimeString('es-ES');
        
        if (!datos || datos.length === 0) {
          tabla.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No hay tr√°fico capturado a√∫n. Ejecuta capturaRed.py para comenzar.</td></tr>';
          if (contador) contador.textContent = '0 paquetes';
          if (ultimaAct) ultimaAct.textContent = 'Sin datos';
          return;
        }

        if (contador) contador.textContent = `${datos.length} paquetes`;
        if (ultimaAct) ultimaAct.textContent = `√öltima actualizaci√≥n: ${hora}`;

        datos.slice(-40).reverse().forEach(paquete => {
          const etiqueta = paquete.etiqueta || 'BENIGN';
          const esAtaque = etiqueta !== 'BENIGN';
          const colorFila = esAtaque ? 'background-color: #2c1010;' : '';
          const colorTexto = esAtaque ? 'color: #ffcd00; font-weight: 600;' : 'color: #6cffb0;';
          const icono = esAtaque ? '‚ö†Ô∏è ' : '‚úì ';
          
          const fila = `
            <tr style="${colorFila}">
              <td>${paquete.hora}</td>
              <td>${paquete.ip_origen}</td>
              <td>${paquete.puerto_origen}</td>
              <td>${paquete.ip_destino}</td>
              <td>${paquete.puerto_destino}</td>
              <td>${paquete.protocolo}</td>
              <td style="${colorTexto}">${icono}${etiqueta}</td>
            </tr>`;
          tabla.innerHTML += fila;
        });
      } catch (err) {
        const tabla = document.getElementById('tabla-trafico');
        tabla.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #d32f2f;">Error al cargar datos. Aseg√∫rate de que el servidor est√© ejecut√°ndose y que trafico.json exista.</td></tr>';
        console.error('Error al cargar datos:', err);
      }
    }

    async function cargarAlertas() {
      try {
        const respuesta = await fetch('CapturaTrafico/alertas.json');
        if (!respuesta.ok) return;
        
        const alertas = await respuesta.json();
        const seccionAlertas = document.getElementById('seccion-alertas');
        const listaAlertas = document.getElementById('lista-alertas');
        const contadorAlertas = document.getElementById('contador-alertas');
        
        if (!alertas || alertas.length === 0) {
          seccionAlertas.style.display = 'none';
          if (contadorAlertas) contadorAlertas.style.display = 'none';
          return;
        }
        
        seccionAlertas.style.display = 'block';
        if (contadorAlertas) {
          contadorAlertas.style.display = 'inline-block';
          contadorAlertas.textContent = `${alertas.length} alerta${alertas.length > 1 ? 's' : ''}`;
        }
        
        listaAlertas.innerHTML = '';
        alertas.slice(-10).reverse().forEach(alerta => {
          const alertaDiv = document.createElement('div');
          alertaDiv.classList.add('ips-alerta');
          alertaDiv.innerHTML = `
            <strong>${alerta.tipo_ataque || 'Ataque detectado'}</strong> 
            (${(alerta.probabilidad * 100).toFixed(1)}%)<br>
            <small>${alerta.hora} | ${alerta.ip_origen}:${alerta.puerto_origen} ‚Üí ${alerta.ip_destino}:${alerta.puerto_destino}</small>
          `;
          listaAlertas.appendChild(alertaDiv);
        });
      } catch (err) {
        console.error('Error al cargar alertas:', err);
      }
    }

    // Actualiza la tabla y alertas cada 3 segundos
    setInterval(() => {
      cargarDatos();
      cargarAlertas();
    }, 3000);
    cargarDatos();
    cargarAlertas();

  </script>
</body>
</html>
