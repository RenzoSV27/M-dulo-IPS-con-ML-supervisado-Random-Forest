<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPS - Alertas de Seguridad</title>
  <link rel="stylesheet" href="IPS.css">
</head>
<body>
  <div class="app-ips">
    <header class="cabecera-ips">
      <div class="marca-cabecera">
        <div class="logo-ips">
          <img src="../upnLogo.png" alt="Logo Universidad Privada del Norte">
        </div>
        <div>
          <p class="supertexto-cabecera">Sistemas Inteligentes y Aprendizaje Autom√°tico</p>
          <h1>Alertas de Seguridad - IPS</h1>
        </div>
      </div>
      <nav class="navegacion-ips">
        <a href="../panelAdmin.html">Inicio</a>
        <a href="IPS.html">Tr√°fico de Red</a>
        <a class="active" href="#">Alertas</a>
      </nav>
      <div class="meta-cabecera">
        <span>Vigilancia constante</span>
        <span>Modelos entrenados</span>
      </div>
    </header>

    <main class="principal-ips">
      <section class="destacado-ips">
        <div class="texto-destacado">
          <h2>Alertas de Intrusos en la Red</h2>
          <p>Seguimiento continuo de amenazas para proteger los servicios digitales de la Universidad Privada del Norte.</p>
        </div>
        <div class="contadores-destacados">
          <div class="contador-destacado">
            <span class="etiqueta-contador">Alertas activas</span>
            <strong id="contador-alertas">0 alertas</strong>
          </div>
          <div class="contador-destacado">
            <span class="etiqueta-contador">√öltima actualizaci√≥n</span>
            <strong id="ultima-actualizacion">Actualizando...</strong>
          </div>
        </div>
      </section>

      <section class="alertas-ips">
        <div class="tarjeta-alertas">
          <div class="encabezado-alertas">
            <p>Resumen de alertas</p>
          </div>
          <div id="resumen-alertas" class="resumen-alertas">
            <!-- Las tarjetas de promedio aparecer√°n aqu√≠ -->
          </div>
        </div>
      </section>

      <section class="seccion-tabla">
        <div class="encabezado-tabla">
          <h2>Detalles de alertas</h2>
          <p>Registro completo de intrusiones detectadas.</p>
        </div>
        <div class="contenedor-tabla">
          <table class="tabla-ips">
            <thead>
              <tr>
                <th>Hora</th>
                <th>IP Origen</th>
                <th>Puerto Origen</th>
                <th>IP Destino</th>
                <th>Puerto Destino</th>
                <th>Tipo de Ataque</th>
                <th>Probabilidad</th>
                <th>Severidad</th>
              </tr>
            </thead>
            <tbody id="tabla-alertas">
              <tr><td colspan="8">Cargando alertas...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="pie-ips">
      <p>2025 Sistema IPS ¬∑ Sistemas Inteligentes y Aprendizaje Autom√°tico ¬∑ Universidad Privada del Norte</p>
    </footer>
  </div>

  <script>
    function obtenerSeveridad(tipoAtaque, probabilidad) {
      if (tipoAtaque === 'BENIGN') return { nivel: 'Baja', color: '#4caf50' };
      
      const ataquesCriticos = ['DDoS', 'Botnet', 'Infiltration'];
      const ataquesAltos = ['Web Attack - SQL Injection', 'Web Attack - XSS'];
      const ataquesMedios = ['Web Attack - Brute Force', 'Port Scan'];
      
      if (ataquesCriticos.some(a => tipoAtaque.includes(a))) {
        return { nivel: 'Cr√≠tica', color: '#d32f2f' };
      } else if (ataquesAltos.some(a => tipoAtaque.includes(a))) {
        return { nivel: 'Alta', color: '#f57c00' };
      } else if (ataquesMedios.some(a => tipoAtaque.includes(a))) {
        return { nivel: 'Media', color: '#fbc02d' };
      } else {
        if (probabilidad >= 0.8) return { nivel: 'Alta', color: '#f57c00' };
        if (probabilidad >= 0.6) return { nivel: 'Media', color: '#fbc02d' };
        return { nivel: 'Baja', color: '#ffa726' };
      }
    }

    function obtenerIconoAtaque(tipoAtaque) {
      if (tipoAtaque === 'BENIGN') return '‚úì';
      if (tipoAtaque.includes('DDoS')) return 'üåê';
      if (tipoAtaque.includes('Brute Force')) return 'üîë';
      if (tipoAtaque.includes('SQL Injection')) return 'üíâ';
      if (tipoAtaque.includes('XSS')) return 'üìú';
      if (tipoAtaque.includes('Port Scan')) return 'üîç';
      if (tipoAtaque.includes('Infiltration')) return 'üïµÔ∏è';
      return '‚ö†Ô∏è';
    }

    async function cargarAlertas() {
      try {
        const respuesta = await fetch('CapturaTrafico/alertas.json');
        if (!respuesta.ok) throw new Error("No se pudo cargar el archivo JSON");
        
        const alertas = await respuesta.json();
        const tabla = document.getElementById('tabla-alertas');
        const contador = document.getElementById('contador-alertas');
        const ultimaAct = document.getElementById('ultima-actualizacion');
        const resumen = document.getElementById('resumen-alertas');
        
        const ahora = new Date();
        const hora = ahora.toLocaleTimeString('es-ES');
        
        if (!alertas || alertas.length === 0) {
          tabla.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #999;">No hay alertas registradas. El sistema est√° funcionando normalmente.</td></tr>';
          if (contador) contador.textContent = '0 alertas';
          if (ultimaAct) ultimaAct.textContent = 'Sin alertas';
          resumen.innerHTML = '';
          return;
        }

        if (contador) contador.textContent = `${alertas.length} alerta${alertas.length > 1 ? 's' : ''}`;
        if (ultimaAct) ultimaAct.textContent = `√öltima actualizaci√≥n: ${hora}`;

        const tiposAtaque = {};
        let totalProbabilidad = 0;
        alertas.forEach(alerta => {
          const tipo = alerta.tipo_ataque || 'Desconocido';
          tiposAtaque[tipo] = (tiposAtaque[tipo] || 0) + 1;
          totalProbabilidad += alerta.probabilidad || 0;
        });

        const promedioProbabilidad = (totalProbabilidad / alertas.length * 100).toFixed(1);

        const tiposUnicos = Object.keys(tiposAtaque).length;
        resumen.innerHTML = `
          <div class="resumen-card">
            <div class="resumen-card__valor">${alertas.length}</div>
            <div class="resumen-card__etiqueta">Total alertas</div>
          </div>
          <div class="resumen-card">
            <div class="resumen-card__valor">${tiposUnicos}</div>
            <div class="resumen-card__etiqueta">Tipos de ataque</div>
          </div>
          <div class="resumen-card">
            <div class="resumen-card__valor">${promedioProbabilidad}%</div>
            <div class="resumen-card__etiqueta">Probabilidad promedio</div>
          </div>
        `;

        tabla.innerHTML = '';
        alertas.slice().reverse().forEach(alerta => {
          const severidad = obtenerSeveridad(alerta.tipo_ataque, alerta.probabilidad);
          const icono = obtenerIconoAtaque(alerta.tipo_ataque);
          const probabilidadPorcentaje = (alerta.probabilidad * 100).toFixed(1);
          
          const fila = `
            <tr style="background-color: ${severidad.color}20;">
              <td>${alerta.hora}</td>
              <td>${alerta.ip_origen}</td>
              <td>${alerta.puerto_origen}</td>
              <td>${alerta.ip_destino}</td>
              <td>${alerta.puerto_destino}</td>
              <td style="font-weight: bold;">${icono} ${alerta.tipo_ataque || 'Desconocido'}</td>
              <td>
                <div style="background: ${severidad.color}40; padding: 4px 8px; border-radius: 4px; display: inline-block; min-width: 60px; text-align: center;">
                  ${probabilidadPorcentaje}%
                </div>
              </td>
              <td style="color: ${severidad.color}; font-weight: bold;">${severidad.nivel}</td>
            </tr>`;
          tabla.innerHTML += fila;
        });
      } catch (err) {
        const tabla = document.getElementById('tabla-alertas');
        tabla.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #d32f2f;">Error al cargar alertas. Aseg√∫rate de que el servidor est√© ejecut√°ndose y que alertas.json exista.</td></tr>';
        console.error('Error al cargar alertas:', err);
      }
    }

    setInterval(cargarAlertas, 3000);
    cargarAlertas();
  </script>
</body>
</html>

